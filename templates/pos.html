{% extends "_base.html" %}
{% block title %}POS หน้าขาย{% endblock %}
{% block content %}
<h1 class="text-xl font-semibold mb-3">หน้าขาย</h1>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <!-- สินค้า -->
  <div class="md:col-span-2">
    <input id="search" placeholder="ค้นหา…" class="w-full mb-3 p-2 border rounded">
    <div class="flex gap-2 overflow-x-auto mb-3">
      <button class="px-3 py-1 border rounded" onclick="filterCat('ALL')">ทั้งหมด</button>
      {% for c in categories %}
      <button class="px-3 py-1 border rounded" onclick="filterCat('{{ c }}')">{{ c }}</button>
      {% endfor %}
    </div>
    <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
      {% for p in products if p.active %}
      <button class="bg-white border rounded-xl p-3 text-left shadow-sm"
              data-name="{{ p.name }}" data-price="{{ '%.2f'|format(p.price) }}" data-cat="{{ p.category }}"
              onclick="addItem('{{ p.name|e }}', {{ p.price }})">
        {% if p.image %}
          <img src="{{ p.image }}" class="w-full h-28 object-cover rounded mb-2">
        {% endif %}
        <div class="font-medium">{{ p.name }}</div>
        <div class="text-sm text-slate-500">{{ '฿%.2f'|format(p.price) }}</div>
      </button>
      {% endfor %}
    </div>
  </div>

  <!-- ตะกร้า -->
  <div class="bg-white border rounded-xl p-3 shadow-sm">
    <h2 class="font-semibold mb-2">ตะกร้า</h2>
    <div id="cart" class="space-y-2"></div>
    <div class="mt-3 border-t pt-3 text-right">
      <div>ยอดรวม: <span id="subtotal">0.00</span></div>
      <div class="flex items-center justify-end gap-2 my-2">
        ส่วนลด: <input id="discount" type="number" step="0.01" value="0" class="w-24 p-1 border rounded text-right">
      </div>
      <div class="text-lg font-bold">สุทธิ: <span id="grandTotal">0.00</span></div>
      <div class="mt-3 flex gap-2">
        <button class="flex-1 py-2 bg-emerald-600 text-white rounded" onclick="pay('CASH')">เงินสด</button>
        <button class="flex-1 py-2 bg-blue-600 text-white rounded" onclick="pay('TRANSFER')">โอน</button>
      </div>
    </div>
  </div>
</div>

<script>
let cart = [];
function addItem(name, price){
  const found = cart.find(i=>i.name===name);
  if(found){ found.qty++; } else { cart.push({name, price, qty:1}); }
  render();
}
function removeItem(name){
  cart = cart.filter(i=>i.name!==name); render();
}
function changeQty(name, d){
  const it = cart.find(i=>i.name===name);
  if(!it) return;
  it.qty = Math.max(1, it.qty + d); render();
}
function render(){
  const el = document.getElementById('cart');
  el.innerHTML = cart.map(i=>`
    <div class="flex items-center justify-between gap-2">
      <div>
        <div class="font-medium">${i.name}</div>
        <div class="text-sm text-slate-500">฿${i.price.toFixed(2)} x ${i.qty}</div>
      </div>
      <div class="flex items-center gap-1">
        <button class="px-2 py-1 border rounded" onclick="changeQty('${i.name}',-1)">-</button>
        <button class="px-2 py-1 border rounded" onclick="changeQty('${i.name}',1)">+</button>
        <button class="px-2 py-1 border rounded" onclick="removeItem('${i.name}')">ลบ</button>
      </div>
    </div>
  `).join('');
  const subtotal = cart.reduce((s,i)=>s+i.price*i.qty,0);
  document.getElementById('subtotal').textContent = subtotal.toFixed(2);
  const discount = parseFloat(document.getElementById('discount').value||0);
  document.getElementById('grandTotal').textContent = Math.max(subtotal-discount,0).toFixed(2);
}
function pay(method){
  if(cart.length===0) return alert('ยังไม่มีสินค้า');
  const discount = parseFloat(document.getElementById('discount').value||0);
  fetch("/checkout", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ items: cart, discount, payment: method })
  }).then(r=>r.json()).then(res=>{
    if(res.ok){ alert(`ชำระเสร็จ บิล #${res.order_id}\nยอดสุทธิ ฿${res.total.toFixed(2)}`); cart=[]; render(); }
  });
}
function filterCat(cat){
  document.querySelectorAll('#productGrid > button').forEach(b=>{
    const c = b.getAttribute('data-cat');
    b.style.display = (cat==='ALL' || c===cat) ? '' : 'none';
  });
}
document.getElementById('search').addEventListener('input', e=>{
  const q = e.target.value.toLowerCase();
  document.querySelectorAll('#productGrid > button').forEach(b=>{
    const name = b.getAttribute('data-name').toLowerCase();
    b.style.display = name.includes(q) ? '' : 'none';
  });
});
</script>
{% endblock %}
